# 微信小程序调试指南

## 目录
- [开发环境调试](#开发环境调试)
- [真机测试](#真机测试)
- [性能调试](#性能调试)
- [网络调试](#网络调试)
- [常见问题排查](#常见问题排查)
- [调试工具使用](#调试工具使用)
- [测试用例执行](#测试用例执行)

## 开发环境调试

### 1. 微信开发者工具调试

#### 基础调试功能
```javascript
// 在代码中添加调试信息
console.log('调试信息:', data);
console.error('错误信息:', error);
console.warn('警告信息:', warning);

// 使用断点调试
debugger; // 在需要断点的地方添加
```

#### 调试面板使用
1. **Console面板**: 查看日志输出和错误信息
2. **Sources面板**: 设置断点，单步调试
3. **Network面板**: 监控网络请求
4. **Storage面板**: 查看本地存储数据
5. **AppData面板**: 查看页面数据变化

### 2. 代码调试技巧

#### 页面生命周期调试
```javascript
// pages/index/index.js
Page({
  onLoad: function(options) {
    console.log('页面加载:', options);
  },
  
  onShow: function() {
    console.log('页面显示');
  },
  
  onReady: function() {
    console.log('页面渲染完成');
  },
  
  onHide: function() {
    console.log('页面隐藏');
  },
  
  onUnload: function() {
    console.log('页面卸载');
  }
});
```

#### 数据绑定调试
```javascript
// 监控数据变化
Page({
  data: {
    userInfo: null,
    loading: false
  },
  
  setUserInfo: function(userInfo) {
    console.log('设置用户信息前:', this.data.userInfo);
    this.setData({
      userInfo: userInfo
    }, () => {
      console.log('设置用户信息后:', this.data.userInfo);
    });
  }
});
```

## 真机测试

### 1. 真机调试准备

#### 手机设置
1. 确保手机和电脑在同一网络
2. 微信版本需要支持小程序
3. 开启微信调试模式

#### 开发者工具设置
1. 点击工具栏「真机调试」
2. 扫描二维码
3. 在手机上确认调试

### 2. 真机调试功能

#### vConsole调试
```javascript
// 在app.js中启用vConsole（仅开发环境）
App({
  onLaunch: function() {
    // 开发环境启用vConsole
    if (wx.getAccountInfoSync().miniProgram.envVersion === 'develop') {
      wx.setEnableDebug({
        enableDebug: true
      });
    }
  }
});
```

#### 真机日志查看
```javascript
// 使用wx.getLogManager记录日志
const logger = wx.getLogManager({level: 0});

// 记录不同级别的日志
logger.debug('调试信息');
logger.info('普通信息');
logger.warn('警告信息');
logger.error('错误信息');
```

### 3. 真机测试检查清单

#### 功能测试
- [ ] 页面跳转正常
- [ ] 网络请求成功
- [ ] 本地存储功能
- [ ] 用户授权流程
- [ ] WebView页面加载
- [ ] H5与小程序通信

#### 性能测试
- [ ] 页面加载速度
- [ ] 内存使用情况
- [ ] 网络请求耗时
- [ ] 动画流畅度

#### 兼容性测试
- [ ] 不同机型适配
- [ ] 不同微信版本
- [ ] 不同网络环境
- [ ] 横竖屏切换

## 性能调试

### 1. 性能监控

#### 使用Performance API
```javascript
// 监控页面性能
Page({
  onLoad: function() {
    const startTime = Date.now();
    
    // 页面加载完成后计算耗时
    this.setData({
      loading: false
    }, () => {
      const loadTime = Date.now() - startTime;
      console.log('页面加载耗时:', loadTime + 'ms');
      
      // 上报性能数据
      wx.reportPerformance(1001, loadTime);
    });
  }
});
```

#### 内存使用监控
```javascript
// 监控内存使用
function checkMemoryUsage() {
  const performance = wx.getPerformance();
  if (performance && performance.memory) {
    console.log('内存使用情况:', {
      used: performance.memory.usedJSHeapSize,
      total: performance.memory.totalJSHeapSize,
      limit: performance.memory.jsHeapSizeLimit
    });
  }
}
```

### 2. 性能优化建议

#### 代码优化
```javascript
// 避免频繁setData
// 错误示例
for (let i = 0; i < 100; i++) {
  this.setData({
    [`list[${i}]`]: data[i]
  });
}

// 正确示例
const updateData = {};
for (let i = 0; i < 100; i++) {
  updateData[`list[${i}]`] = data[i];
}
this.setData(updateData);
```

#### 图片优化
```javascript
// 图片懒加载
Page({
  data: {
    imageList: [],
    loadedImages: {}
  },
  
  onImageLoad: function(e) {
    const index = e.currentTarget.dataset.index;
    this.setData({
      [`loadedImages[${index}]`]: true
    });
  }
});
```

## 网络调试

### 1. 网络请求调试

#### 请求拦截器
```javascript
// utils/request.js
const originalRequest = wx.request;

wx.request = function(options) {
  console.log('请求开始:', {
    url: options.url,
    method: options.method,
    data: options.data
  });
  
  const startTime = Date.now();
  
  const originalSuccess = options.success;
  options.success = function(res) {
    const endTime = Date.now();
    console.log('请求成功:', {
      url: options.url,
      duration: endTime - startTime,
      statusCode: res.statusCode,
      data: res.data
    });
    
    if (originalSuccess) {
      originalSuccess(res);
    }
  };
  
  const originalFail = options.fail;
  options.fail = function(err) {
    console.error('请求失败:', {
      url: options.url,
      error: err
    });
    
    if (originalFail) {
      originalFail(err);
    }
  };
  
  return originalRequest(options);
};
```

#### 网络状态监控
```javascript
// 监控网络状态变化
App({
  onLaunch: function() {
    // 监听网络状态变化
    wx.onNetworkStatusChange(function(res) {
      console.log('网络状态变化:', {
        isConnected: res.isConnected,
        networkType: res.networkType
      });
      
      if (!res.isConnected) {
        wx.showToast({
          title: '网络连接断开',
          icon: 'none'
        });
      }
    });
  }
});
```

### 2. 域名配置调试

#### 检查域名白名单
```javascript
// 验证域名是否在白名单中
function checkDomainWhitelist(url) {
  const domain = new URL(url).hostname;
  console.log('检查域名:', domain);
  
  // 这里应该与project.config.json中的域名配置对比
  const allowedDomains = [
    'api.example.com',
    'test-api.example.com',
    'dev-api.example.com'
  ];
  
  const isAllowed = allowedDomains.includes(domain);
  console.log('域名是否允许:', isAllowed);
  
  return isAllowed;
}
```

## 常见问题排查

### 1. 页面问题

#### 页面白屏
```javascript
// 检查页面路径和配置
Page({
  onLoad: function() {
    console.log('当前页面路径:', getCurrentPages());
    
    // 检查页面数据
    if (!this.data) {
      console.error('页面数据未初始化');
    }
  },
  
  onError: function(error) {
    console.error('页面错误:', error);
    wx.showToast({
      title: '页面加载失败',
      icon: 'none'
    });
  }
});
```

#### 页面跳转失败
```javascript
// 页面跳转错误处理
function navigateToPage(url) {
  wx.navigateTo({
    url: url,
    success: function() {
      console.log('页面跳转成功:', url);
    },
    fail: function(error) {
      console.error('页面跳转失败:', error);
      
      // 尝试使用redirectTo
      wx.redirectTo({
        url: url,
        fail: function(error2) {
          console.error('重定向也失败:', error2);
          wx.showToast({
            title: '页面跳转失败',
            icon: 'none'
          });
        }
      });
    }
  });
}
```

### 2. 网络问题

#### 请求失败排查
```javascript
// 网络请求错误处理
function handleRequestError(error, url) {
  console.error('请求错误详情:', {
    url: url,
    error: error,
    errMsg: error.errMsg
  });
  
  let errorMessage = '网络请求失败';
  
  if (error.errMsg) {
    if (error.errMsg.includes('timeout')) {
      errorMessage = '请求超时，请检查网络连接';
    } else if (error.errMsg.includes('fail')) {
      errorMessage = '网络连接失败';
    } else if (error.errMsg.includes('domain')) {
      errorMessage = '域名未配置，请联系开发者';
    }
  }
  
  wx.showToast({
    title: errorMessage,
    icon: 'none'
  });
}
```

### 3. 权限问题

#### 权限获取失败
```javascript
// 权限检查和处理
function checkAndRequestPermission(scope, callback) {
  wx.getSetting({
    success: function(res) {
      if (res.authSetting[scope]) {
        // 已授权
        callback(true);
      } else if (res.authSetting[scope] === false) {
        // 用户拒绝过，需要引导到设置页面
        wx.showModal({
          title: '权限申请',
          content: '需要相关权限才能正常使用功能，请在设置中开启',
          confirmText: '去设置',
          success: function(modalRes) {
            if (modalRes.confirm) {
              wx.openSetting();
            }
          }
        });
      } else {
        // 未询问过，直接申请
        wx.authorize({
          scope: scope,
          success: function() {
            callback(true);
          },
          fail: function() {
            callback(false);
          }
        });
      }
    }
  });
}
```

## 调试工具使用

### 1. 测试用例执行

#### 在页面中运行测试
```javascript
// pages/index/index.js
const { runQuickTests, runAllTests } = require('../../tests/test-cases.js');

Page({
  data: {
    testResults: null
  },
  
  // 运行快速测试
  onRunQuickTests: function() {
    const results = runQuickTests();
    this.setData({
      testResults: results
    });
  },
  
  // 运行完整测试
  onRunAllTests: async function() {
    wx.showLoading({ title: '测试中...' });
    
    try {
      const results = await runAllTests();
      this.setData({
        testResults: results
      });
    } catch (error) {
      console.error('测试执行失败:', error);
    } finally {
      wx.hideLoading();
    }
  }
});
```

### 2. 调试命令

#### 开发者工具控制台命令
```javascript
// 在控制台中执行的调试命令

// 查看当前页面信息
getCurrentPages();

// 查看应用实例
getApp();

// 查看存储数据
wx.getStorageInfoSync();

// 清空存储
wx.clearStorageSync();

// 模拟网络状态
wx.onNetworkStatusChange(console.log);

// 查看系统信息
wx.getSystemInfoSync();
```

## 测试用例执行

### 1. 自动化测试

#### 在应用启动时运行测试
```javascript
// app.js
App({
  onLaunch: function() {
    // 仅在开发环境运行测试
    if (wx.getAccountInfoSync().miniProgram.envVersion === 'develop') {
      const { runQuickTests } = require('./tests/test-cases.js');
      
      setTimeout(() => {
        console.log('开始执行自动化测试...');
        runQuickTests();
      }, 2000);
    }
  }
});
```

### 2. 手动测试

#### 测试页面模板
```xml
<!-- pages/test/test.wxml -->
<view class="test-container">
  <view class="test-header">
    <text class="test-title">小程序测试中心</text>
  </view>
  
  <view class="test-buttons">
    <button bindtap="onRunQuickTests" class="test-btn">快速测试</button>
    <button bindtap="onRunAllTests" class="test-btn">完整测试</button>
    <button bindtap="onClearResults" class="test-btn">清空结果</button>
  </view>
  
  <view class="test-results" wx:if="{{testResults}}">
    <text class="results-title">测试结果</text>
    <view class="results-summary">
      <text>总计: {{testResults.summary.total}}</text>
      <text>通过: {{testResults.summary.passed}}</text>
      <text>失败: {{testResults.summary.failed}}</text>
      <text>通过率: {{testResults.summary.passRate}}</text>
    </view>
  </view>
</view>
```

## 总结

本调试指南涵盖了微信小程序开发过程中的主要调试场景和解决方案。在实际开发中，建议：

1. **开发阶段**: 充分利用开发者工具的调试功能
2. **测试阶段**: 结合真机测试和自动化测试
3. **上线前**: 进行完整的功能和性能测试
4. **问题排查**: 使用系统化的方法定位和解决问题

记住，良好的调试习惯和完善的测试用例是保证小程序质量的关键。