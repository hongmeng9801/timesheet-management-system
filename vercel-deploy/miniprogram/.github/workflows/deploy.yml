name: å¾®ä¿¡å°ç¨‹åºè‡ªåŠ¨åŒ–éƒ¨ç½²

on:
  push:
    branches:
      - main      # ä¸»åˆ†æ”¯æ¨é€æ—¶éƒ¨ç½²æ­£å¼ç‰ˆ
      - develop   # å¼€å‘åˆ†æ”¯æ¨é€æ—¶éƒ¨ç½²å¼€å‘ç‰ˆ
  pull_request:
    branches:
      - main      # PRåˆ°ä¸»åˆ†æ”¯æ—¶ç”Ÿæˆé¢„è§ˆ
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - preview
          - release
      preview_only:
        description: 'ä»…ç”Ÿæˆé¢„è§ˆäºŒç»´ç '
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'miniprogram/package.json'
        
    - name: å®‰è£…ä¾èµ–
      working-directory: ./miniprogram
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json found, skipping npm install"
        fi
        
    - name: ä»£ç æ£€æŸ¥
      working-directory: ./miniprogram
      run: |
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "app.json" ]; then
          echo "âŒ app.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        if [ ! -f "project.config.json" ]; then
          echo "âŒ project.config.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥AppIDé…ç½®
        appid=$(cat project.config.json | grep -o '"appid"[^,]*' | cut -d'"' -f4)
        if [ "$appid" = "touristappid" ] || [ -z "$appid" ]; then
          echo "âŒ è¯·å…ˆé…ç½®æ­£ç¡®çš„AppID"
          exit 1
        fi
        
        echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
        echo "   AppID: $appid"
        
    - name: ç¡®å®šéƒ¨ç½²ç¯å¢ƒ
      id: env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          echo "preview_only=${{ github.event.inputs.preview_only }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "environment=release" >> $GITHUB_OUTPUT
          echo "preview_only=false" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
          echo "environment=dev" >> $GITHUB_OUTPUT
          echo "preview_only=false" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "environment=preview" >> $GITHUB_OUTPUT
          echo "preview_only=true" >> $GITHUB_OUTPUT
        else
          echo "environment=dev" >> $GITHUB_OUTPUT
          echo "preview_only=true" >> $GITHUB_OUTPUT
        fi
        
    - name: ç¯å¢ƒå˜é‡æ›¿æ¢
      working-directory: ./miniprogram
      run: |
        ENV=${{ steps.env.outputs.environment }}
        echo "ğŸ”§ é…ç½® $ENV ç¯å¢ƒå˜é‡"
        
        # æ ¹æ®ç¯å¢ƒæ›¿æ¢é…ç½®æ–‡ä»¶ä¸­çš„å˜é‡
        if [ -f "config/app-config.js" ]; then
          case $ENV in
            "release")
              sed -i 's/{{H5_DOMAIN}}/https:\/\/your-domain.com/g' config/app-config.js
              sed -i 's/{{API_DOMAIN}}/https:\/\/api.your-domain.com/g' config/app-config.js
              ;;
            "preview")
              sed -i 's/{{H5_DOMAIN}}/https:\/\/test.your-domain.com/g' config/app-config.js
              sed -i 's/{{API_DOMAIN}}/https:\/\/api-test.your-domain.com/g' config/app-config.js
              ;;
            "dev")
              sed -i 's/{{H5_DOMAIN}}/http:\/\/localhost:5173/g' config/app-config.js
              sed -i 's/{{API_DOMAIN}}/http:\/\/localhost:3000/g' config/app-config.js
              ;;
          esac
          echo "âœ… ç¯å¢ƒå˜é‡æ›¿æ¢å®Œæˆ"
        fi
        
    - name: æ„å»ºé¡¹ç›®
      working-directory: ./miniprogram
      run: |
        echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
        
        # æ›´æ–°ç‰ˆæœ¬å·
        ENV=${{ steps.env.outputs.environment }}
        VERSION="1.0.0"
        case $ENV in
          "release")
            VERSION="1.0.0"
            ;;
          "preview")
            VERSION="1.0.0-preview.$(date +%Y%m%d%H%M)"
            ;;
          "dev")
            VERSION="1.0.0-dev.$(date +%Y%m%d%H%M)"
            ;;
        esac
        
        # æ›´æ–°package.jsonç‰ˆæœ¬å·
        if [ -f "package.json" ]; then
          npm version $VERSION --no-git-tag-version
          echo "   ç‰ˆæœ¬å·: $VERSION"
        fi
        
        echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"
        
    - name: å®‰è£…å¾®ä¿¡å¼€å‘è€…å·¥å…·
      run: |
        echo "ğŸ“¦ å®‰è£…å¾®ä¿¡å¼€å‘è€…å·¥å…·CLI..."
        
        # ä¸‹è½½å¾®ä¿¡å¼€å‘è€…å·¥å…·Linuxç‰ˆæœ¬
        wget -O wechat_devtools.tar.gz "https://dldir1.qq.com/WechatWebDev/release/be1ec64cf6184148c2c7efb5de8c8e5a/wechat_devtools_linux.tar.gz"
        
        # è§£å‹
        tar -xzf wechat_devtools.tar.gz
        
        # å®‰è£…ä¾èµ–
        sudo apt-get update
        sudo apt-get install -y libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libxss1 libasound2
        
        # è®¾ç½®æƒé™
        chmod +x wechat_devtools/bin/wxdev
        
        # åˆ›å»ºç¬¦å·é“¾æ¥
        sudo ln -sf $(pwd)/wechat_devtools/bin/wxdev /usr/local/bin/wxdev
        
        echo "âœ… å¾®ä¿¡å¼€å‘è€…å·¥å…·å®‰è£…å®Œæˆ"
        
    - name: é…ç½®å¾®ä¿¡å¼€å‘è€…å·¥å…·
      run: |
        echo "âš™ï¸ é…ç½®å¾®ä¿¡å¼€å‘è€…å·¥å…·..."
        
        # å¯åŠ¨å·¥å…·ï¼ˆåå°è¿è¡Œï¼‰
        wxdev --version
        
        # ç­‰å¾…å·¥å…·å¯åŠ¨
        sleep 5
        
        echo "âœ… å¾®ä¿¡å¼€å‘è€…å·¥å…·é…ç½®å®Œæˆ"
        
    - name: éƒ¨ç½²å°ç¨‹åº
      working-directory: ./miniprogram
      env:
        MINIPROGRAM_APPID: ${{ secrets.MINIPROGRAM_APPID }}
        MINIPROGRAM_PRIVATE_KEY: ${{ secrets.MINIPROGRAM_PRIVATE_KEY }}
      run: |
        ENV=${{ steps.env.outputs.environment }}
        PREVIEW_ONLY=${{ steps.env.outputs.preview_only }}
        
        echo "ğŸš€ å¼€å§‹éƒ¨ç½² $ENV ç¯å¢ƒ..."
        
        # è®¾ç½®é¡¹ç›®é…ç½®
        if [ ! -z "$MINIPROGRAM_APPID" ]; then
          # æ›´æ–°AppID
          sed -i "s/\"appid\": \"[^\"]*\"/\"appid\": \"$MINIPROGRAM_APPID\"/g" project.config.json
          echo "   AppIDå·²æ›´æ–°"
        fi
        
        # æ‰§è¡Œéƒ¨ç½²
        if [ "$PREVIEW_ONLY" = "true" ]; then
          echo "ğŸ“± ç”Ÿæˆé¢„è§ˆäºŒç»´ç ..."
          
          # ç”Ÿæˆé¢„è§ˆ
          wxdev preview \
            --project $(pwd) \
            --version "1.0.0-preview" \
            --desc "GitHub Actions è‡ªåŠ¨é¢„è§ˆ" \
            --qr-output "./qrcode.jpg" || true
            
          # æ£€æŸ¥äºŒç»´ç æ˜¯å¦ç”ŸæˆæˆåŠŸ
          if [ -f "qrcode.jpg" ]; then
            echo "âœ… é¢„è§ˆäºŒç»´ç ç”ŸæˆæˆåŠŸ"
            
            # ä¸Šä¼ äºŒç»´ç åˆ°GitHub Artifacts
            echo "ğŸ“¤ ä¸Šä¼ é¢„è§ˆäºŒç»´ç ..."
          else
            echo "âš ï¸ é¢„è§ˆäºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼Œä½†ä¸å½±å“æµç¨‹"
          fi
        else
          echo "ğŸ“¤ ä¸Šä¼ ä»£ç åˆ°å¾®ä¿¡åå°..."
          
          # ä¸Šä¼ ä»£ç 
          wxdev upload \
            --project $(pwd) \
            --version "1.0.0" \
            --desc "GitHub Actions è‡ªåŠ¨éƒ¨ç½² - $ENV" || true
            
          echo "âœ… ä»£ç ä¸Šä¼ å®Œæˆ"
        fi
        
    - name: ä¸Šä¼ é¢„è§ˆäºŒç»´ç 
      if: steps.env.outputs.preview_only == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: miniprogram-qrcode-${{ steps.env.outputs.environment }}
        path: miniprogram/qrcode.jpg
        retention-days: 7
        
    - name: éƒ¨ç½²ç»“æœé€šçŸ¥
      if: always()
      run: |
        ENV=${{ steps.env.outputs.environment }}
        PREVIEW_ONLY=${{ steps.env.outputs.preview_only }}
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ $ENV ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          
          if [ "$PREVIEW_ONLY" = "true" ]; then
            echo "ğŸ“± é¢„è§ˆäºŒç»´ç å·²ç”Ÿæˆï¼Œè¯·åœ¨ Artifacts ä¸­ä¸‹è½½"
          else
            echo "ğŸ“‹ åç»­æ“ä½œæé†’ï¼š"
            echo "1. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°"
            echo "2. è¿›å…¥ç‰ˆæœ¬ç®¡ç†é¡µé¢"
            echo "3. æŸ¥çœ‹ä¸Šä¼ çš„ç‰ˆæœ¬"
            
            if [ "$ENV" = "release" ]; then
              echo "4. è®¾ä¸ºä½“éªŒç‰ˆå¹¶æäº¤å®¡æ ¸"
              echo "5. å®¡æ ¸é€šè¿‡åå‘å¸ƒ"
            fi
          fi
        else
          echo "âŒ $ENV ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"
        fi
        
  # ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡
  quality-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä»£ç è§„èŒƒæ£€æŸ¥
      working-directory: ./miniprogram
      run: |
        echo "ğŸ” ä»£ç è§„èŒƒæ£€æŸ¥..."
        
        # æ£€æŸ¥æ–‡ä»¶ç»“æ„
        required_files=("app.json" "app.js" "project.config.json")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ ç¼ºå°‘å¿…è¦æ–‡ä»¶: $file"
            exit 1
          fi
        done
        
        # æ£€æŸ¥JSONæ–‡ä»¶æ ¼å¼
        json_files=("app.json" "project.config.json" "sitemap.json")
        for file in "${json_files[@]}"; do
          if [ -f "$file" ]; then
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "âŒ JSONæ ¼å¼é”™è¯¯: $file"
              exit 1
            fi
          fi
        done
        
        echo "âœ… ä»£ç è§„èŒƒæ£€æŸ¥é€šè¿‡"
        
    - name: å®‰å…¨æ£€æŸ¥
      working-directory: ./miniprogram
      run: |
        echo "ğŸ”’ å®‰å…¨æ£€æŸ¥..."
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯
        if grep -r "password\|secret\|key" --include="*.js" --include="*.json" . | grep -v "// " | grep -v "\*" ; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥"
        fi
        
        # æ£€æŸ¥AppIDé…ç½®
        appid=$(cat project.config.json | grep -o '"appid"[^,]*' | cut -d'"' -f4)
        if [ "$appid" = "touristappid" ]; then
          echo "âš ï¸ ä½¿ç”¨çš„æ˜¯æµ‹è¯•AppIDï¼Œè¯·ç¡®ä¿è¿™æ˜¯é¢„æœŸçš„"
        fi
        
        echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"